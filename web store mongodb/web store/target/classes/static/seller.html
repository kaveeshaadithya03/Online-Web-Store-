<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="/assets/imgs/logo.png">
    <title>Seller Dashboard</title>
    <link rel="stylesheet" href="/assets/css/styles.css">
    <style>
        .product-list, .form-container { margin: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .error { color: red; }
        .form-container input, .form-container textarea { width: 100%; padding: 8px; margin: 5px 0; }
        .form-container button { padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
<div class="container">
    <div class="navigation">
        <ul>
            <li><span class="icon"><img src="/assets/imgs/logo.png" width="100" height="120" alt="Logo"></span><h4><span class="title">POLA.LK<br>Online Web Store</span></h4></li>
            <li><a href="/seller.html"><span class="icon"><ion-icon name="home-outline"></ion-icon></span><span class="title">Seller Dashboard</span></a></li>
            <li><button id="theme-toggle" class="theme-toggle"><span class="icon"><ion-icon name="moon-outline"></ion-icon></span><span class="title">Toggle Theme</span></button></li>
            <li><a href="/logout"><span class="icon"><ion-icon name="log-out-outline"></ion-icon></span><span class="title">Sign Out</span></a></li>
        </ul>
    </div>
    <div class="main">
        <div class="topbar">
            <div class="toggle"><ion-icon name="menu-outline"></ion-icon></div>
            <div class="search"><label><input type="text" placeholder="Search here"><ion-icon name="search-outline"></ion-icon></label></div>
            <div class="user"><img src="/img/customer01.jpg" alt="User"></div>
        </div>
        <div class="form-container">
            <h2>Seller Dashboard</h2>
            <h3>Add New Product</h3>
            <form id="add-product-form">
                <div>
                    <label for="productID">Product ID:</label>
                    <input type="text" id="productID" name="productID" required>
                </div>
                <div>
                    <label for="productName">Product Name:</label>
                    <input type="text" id="productName" name="productName" required>
                </div>
                <div>
                    <label for="description">Description:</label>
                    <textarea id="description" name="description" required></textarea>
                </div>
                <div>
                    <label for="productPrice">Price:</label>
                    <input type="number" id="productPrice" name="productPrice" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="productCount">Stock Quantity:</label>
                    <input type="number" id="productCount" name="productCount" min="0" required>
                </div>
                <div>
                    <label for="images">Image URL:</label>
                    <input type="text" id="images" name="images">
                </div>
                <button type="submit">Add Product</button>
            </form>
            <div id="add-error" class="error" style="display: none; color: red;"></div>
            <div id="add-success" style="color: green; display: none;"></div>

            <h3>Update Product</h3>
            <form id="update-product-form" style="display: none;">
                <input type="hidden" id="update-id" name="id">
                <div>
                    <label for="update-productID">Product ID:</label>
                    <input type="text" id="update-productID" name="productID" required>
                </div>
                <div>
                    <label for="update-productName">Product Name:</label>
                    <input type="text" id="update-productName" name="productName" required>
                </div>
                <div>
                    <label for="update-description">Description:</label>
                    <textarea id="update-description" name="description" required></textarea>
                </div>
                <div>
                    <label for="update-productPrice">Price:</label>
                    <input type="number" id="update-productPrice" name="productPrice" min="0" step="0.01" required>
                </div>
                <div>
                    <label for="update-productCount">Stock Quantity:</label>
                    <input type="number" id="update-productCount" name="productCount" min="0" required>
                </div>
                <div>
                    <label for="update-images">Image URL:</label>
                    <input type="text" id="update-images" name="images">
                </div>
                <button type="submit">Update Product</button>
                <button type="button" id="cancel-update">Cancel</button>
            </form>
            <div id="update-error" class="error" style="display: none; color: red;"></div>
            <div id="update-success" style="color: green; display: none;"></div>

            <h3>Your Products</h3>
            <table id="product-table">
                <thead>
                <tr>
                    <th>Product ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Image</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>
<script>
    // Navigation and theme toggle
    let list = document.querySelectorAll('.navigation li');
    function activeLink() {
        list.forEach(item => item.classList.remove('hovered'));
        this.classList.add('hovered');
    }
    list.forEach(item => item.addEventListener('mouseover', activeLink));
    let toggle = document.querySelector('.toggle');
    let navigation = document.querySelector('.navigation');
    let main = document.querySelector('.main');
    toggle.onclick = function () {
        navigation.classList.toggle('active');
        main.classList.toggle('active');
    };
    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-theme');
    });

    // Helper function to clear messages
    function clearMessages() {
        document.getElementById('add-error').style.display = 'none';
        document.getElementById('add-success').style.display = 'none';
        document.getElementById('update-error').style.display = 'none';
        document.getElementById('update-success').style.display = 'none';
    }

    // Fetch and display products
    async function fetchProducts() {
        try {
            const response = await fetch('/api/users/products', {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include' // Include cookies for authentication
            });
            if (!response.ok) {
                if (response.status === 401) {
                    document.getElementById('add-error').textContent = 'Unauthorized: Please log in as a seller.';
                    document.getElementById('add-error').style.display = 'block';
                    return;
                }
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const products = await response.json();
            const tbody = document.querySelector('#product-table tbody');
            tbody.innerHTML = '';
            products.forEach(product => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${product.productID}</td>
                    <td>${product.productName}</td>
                    <td>${product.description}</td>
                    <td>$${product.productPrice.toFixed(2)}</td>
                    <td>${product.productCount}</td>
                    <td>${product.images ? `<img src="${product.images}" width="50" alt="Product Image">` : 'No Image'}</td>
                    <td>
                        <button onclick="editProduct('${product.id}')">Edit</button>
                        <button onclick="deleteProduct('${product.id}')">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } catch (error) {
            document.getElementById('add-error').textContent = `Error fetching products: ${error.message}`;
            document.getElementById('add-error').style.display = 'block';
        }
    }

    // Add product form submission
    document.getElementById('add-product-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        clearMessages();
        const formData = new FormData(this);
        const product = {
            productID: formData.get('productID'),
            productName: formData.get('productName'),
            description: formData.get('description'),
            productPrice: parseFloat(formData.get('productPrice')),
            productCount: parseInt(formData.get('productCount')),
            images: formData.get('images') || null
        };
        try {
            const response = await fetch('/api/users/products', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // Include cookies for authentication
                body: JSON.stringify(product)
            });
            if (!response.ok) {
                let errorMessage = `HTTP error! Status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorData.errors?.[0]?.defaultMessage || errorMessage;
                } catch {
                    errorMessage = await response.text();
                }
                throw new Error(errorMessage);
            }
            const savedProduct = await response.json();
            document.getElementById('add-success').textContent = `Product "${savedProduct.productName}" added successfully!`;
            document.getElementById('add-success').style.display = 'block';
            this.reset();
            await fetchProducts();
        } catch (error) {
            document.getElementById('add-error').textContent = `Error adding product: ${error.message}`;
            document.getElementById('add-error').style.display = 'block';
        }
    });

    // Edit product
    async function editProduct(id) {
        try {
            const response = await fetch(`/api/users/products/${id}`, {
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include' // Include cookies for authentication
            });
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Unauthorized: You do not have permission to edit this product.');
                }
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            const product = await response.json();
            document.getElementById('update-id').value = product.id;
            document.getElementById('update-productID').value = product.productID;
            document.getElementById('update-productName').value = product.productName;
            document.getElementById('update-description').value = product.description;
            document.getElementById('update-productPrice').value = product.productPrice;
            document.getElementById('update-productCount').value = product.productCount;
            document.getElementById('update-images').value = product.images || '';
            document.getElementById('update-product-form').style.display = 'block';
            document.getElementById('add-product-form').style.display = 'none';
            clearMessages();
        } catch (error) {
            document.getElementById('update-error').textContent = `Error fetching product: ${error.message}`;
            document.getElementById('update-error').style.display = 'block';
        }
    }

    // Update product form submission
    document.getElementById('update-product-form').addEventListener('submit', async function (e) {
        e.preventDefault();
        clearMessages();
        const formData = new FormData(this);
        const product = {
            productID: formData.get('productID'),
            productName: formData.get('productName'),
            description: formData.get('description'),
            productPrice: parseFloat(formData.get('productPrice')),
            productCount: parseInt(formData.get('productCount')),
            images: formData.get('images') || null
        };
        const id = formData.get('id');
        try {
            const response = await fetch(`/api/users/products/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // Include cookies for authentication
                body: JSON.stringify(product)
            });
            if (!response.ok) {
                let errorMessage = `HTTP error! Status: ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMessage = errorData.message || errorData.errors?.[0]?.defaultMessage || errorMessage;
                } catch {
                    errorMessage = await response.text();
                }
                throw new Error(errorMessage);
            }
            const updatedProduct = await response.json();
            document.getElementById('update-success').textContent = `Product "${updatedProduct.productName}" updated successfully!`;
            document.getElementById('update-success').style.display = 'block';
            document.getElementById('update-product-form').style.display = 'none';
            document.getElementById('add-product-form').style.display = 'block';
            await fetchProducts();
        } catch (error) {
            document.getElementById('update-error').textContent = `Error updating product: ${error.message}`;
            document.getElementById('update-error').style.display = 'block';
        }
    });

    // Cancel update
    document.getElementById('cancel-update').addEventListener('click', () => {
        document.getElementById('update-product-form').style.display = 'none';
        document.getElementById('add-product-form').style.display = 'block';
        clearMessages();
    });

    // Delete product
    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;
        try {
            const response = await fetch(`/api/users/products/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include' // Include cookies for authentication
            });
            if (!response.ok) {
                if (response.status === 403) {
                    throw new Error('Unauthorized: You do not have permission to delete this product.');
                }
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            document.getElementById('add-success').textContent = 'Product deleted successfully!';
            document.getElementById('add-success').style.display = 'block';
            await fetchProducts();
        } catch (error) {
            document.getElementById('add-error').textContent = `Error deleting product: ${error.message}`;
            document.getElementById('add-error').style.display = 'block';
        }
    }

    // Fetch products on page load
    window.addEventListener('load', fetchProducts);
</script>
<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
</body>
</html>