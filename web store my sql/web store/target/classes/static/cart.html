<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cart | POLA.LK</title>
    <link rel="icon" type="image/png" href="/assets/imgs/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/">
            <img src="/assets/imgs/logo.png" alt="POLA.LK Logo" width="100">
            POLA.LK
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/customer.html">Customer DahsBoard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/productList.html">Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="/cart.html">Cart</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout" id="logout-link">Sign Out</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h2>Your Cart</h2>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
    <div id="success-message" class="alert alert-success" style="display: none;"></div>

    <table class="table table-bordered cart-table">
        <thead>
        <tr>
            <th>Image</th>
            <th>Product</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Total</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody id="cart-items">
        <!-- Populated by JavaScript -->
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center mt-4">
        <h4>Total: <span id="cart-total">0.00 LKR</span></h4>
        <div>
            <button class="btn btn-outline-danger me-2" id="clear-cart">Clear Cart</button>
            <button class="btn btn-success" id="checkout">Checkout</button>
        </div>
    </div>

    <div class="mt-4">
        <a href="/productList.html" class="btn btn-outline-secondary">Continue Shopping</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Logout functionality
    document.getElementById('logout-link').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
    });

    // Load and render cart
    function renderCart() {
        const cartItemsBody = document.getElementById('cart-items');
        const cartTotal = document.getElementById('cart-total');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');
        cartItemsBody.innerHTML = '';

        fetch('/api/cart', {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (response.status === 401) {
                    throw new Error('401 Unauthorized');
                }
                if (!response.ok) throw new Error(`Failed to fetch cart: ${response.status}`);
                return response.json();
            })
            .then(cartItems => {
                if (cartItems.length === 0) {
                    cartItemsBody.innerHTML = '<tr><td colspan="6" class="text-center">Your cart is empty.</td></tr>';
                    cartTotal.textContent = '0.00 LKR';
                    return;
                }

                let total = 0;
                cartItems.forEach((item, index) => {
                    const itemTotal = item.productPrice * item.quantity;
                    total += itemTotal;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${item.image ? '/Uploads/products/' + item.image : '/css/images/placeholder.png'}" alt="${item.productName}"></td>
                        <td><a href="/productDetails.html?id=${item.productId}">${item.productName}</a></td>
                        <td>${item.productPrice.toFixed(2)} LKR</td>
                        <td><input type="number" class="form-control quantity-input" data-id="${item.id}" value="${item.quantity}" min="1"></td>
                        <td>${itemTotal.toFixed(2)} LKR</td>
                        <td><button class="btn btn-outline-danger btn-sm remove-item" data-id="${item.id}">Remove</button></td>
                    `;
                    cartItemsBody.appendChild(row);
                });
                cartTotal.textContent = `${total.toFixed(2)} LKR`;

                // Update quantity
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const id = e.target.dataset.id;
                        const newQuantity = parseInt(e.target.value, 10);
                        if (isNaN(newQuantity) || newQuantity < 1) {
                            errorMessage.textContent = 'Please enter a valid quantity.';
                            errorMessage.style.display = 'block';
                            setTimeout(() => errorMessage.style.display = 'none', 3000);
                            e.target.value = cartItems.find(item => item.id === id).quantity;
                            return;
                        }

                        fetch(`/api/cart/update/${id}`, {
                            method: 'PUT',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ productId: cartItems.find(item => item.id === id).productId, quantity: newQuantity })
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Failed to update cart: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(() => {
                                successMessage.textContent = 'Quantity updated!';
                                successMessage.style.display = 'block';
                                setTimeout(() => successMessage.style.display = 'none', 3000);
                                renderCart();
                            })
                            .catch(error => {
                                console.error('Update cart error:', error);
                                errorMessage.textContent = error.message.includes('401') ? 'Please log in to update cart.' : error.message;
                                errorMessage.style.display = 'block';
                                setTimeout(() => {
                                    errorMessage.style.display = 'none';
                                    if (error.message.includes('401')) {
                                        window.location.href = '/login.html';
                                    }
                                }, 3000);
                                e.target.value = cartItems.find(item => item.id === id).quantity;
                            });
                    });
                });

                // Remove item
                document.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const id = e.target.dataset.id;
                        fetch(`/api/cart/${id}`, {
                            method: 'DELETE',
                            credentials: 'include',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`Failed to remove item: ${response.status}`);
                                }
                                successMessage.textContent = 'Item removed from cart!';
                                successMessage.style.display = 'block';
                                setTimeout(() => successMessage.style.display = 'none', 3000);
                                renderCart();
                            })
                            .catch(error => {
                                console.error('Remove item error:', error);
                                errorMessage.textContent = error.message.includes('401') ? 'Please log in to remove items.' : error.message;
                                errorMessage.style.display = 'block';
                                setTimeout(() => {
                                    errorMessage.style.display = 'none';
                                    if (error.message.includes('401')) {
                                        window.location.href = '/login.html';
                                    }
                                }, 3000);
                            });
                    });
                });
            })
            .catch(error => {
                console.error('Fetch cart error:', error);
                errorMessage.textContent = error.message.includes('401') ? 'Please log in to view your cart.' : 'Failed to load cart. Please try again.';
                errorMessage.style.display = 'block';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                    if (error.message.includes('401')) {
                        window.location.href = '/login.html';
                    }
                }, 3000);
            });
    }

    // Clear cart
    document.getElementById('clear-cart').addEventListener('click', () => {
        fetch('/api/cart/clear', {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to clear cart: ${response.status}`);
                }
                document.getElementById('success-message').textContent = 'Cart cleared!';
                document.getElementById('success-message').style.display = 'block';
                setTimeout(() => document.getElementById('success-message').style.display = 'none', 3000);
                renderCart();
            })
            .catch(error => {
                console.error('Clear cart error:', error);
                document.getElementById('error-message').textContent = error.message.includes('401') ? 'Please log in to clear cart.' : error.message;
                document.getElementById('error-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('error-message').style.display = 'none';
                    if (error.message.includes('401')) {
                        window.location.href = '/login.html';
                    }
                }, 3000);
            });
    });

    // Checkout (placeholder)
    document.getElementById('checkout').addEventListener('click', () => {
        alert('Checkout functionality not implemented yet.');
        // Implement checkout API call here
    });

    // Load cart on page load
    window.addEventListener('load', renderCart);
</script>
</body>
</html>