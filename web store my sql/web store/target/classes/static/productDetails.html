<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details | POLA.LK</title>
    <link rel="icon" type="image/png" href="/assets/imgs/logo.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <div class="container">
        <a class="navbar-brand" href="/">
            <img src="/assets/imgs/logo.png" alt="POLA.LK Logo" width="80">
            POLA.LK
        </a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ms-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/customer.html">Customer DahsBoard</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/productList.html">Products</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/cart.html">Cart</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/logout" id="logout-link">Sign Out</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container mt-5 position-relative">
    <!-- Error Message -->
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>

    <!-- Product Details -->
    <div id="product-details" style="display: none;">
        <div class="row">
            <div class="col-12">
                <div id="product-image" class="product-image">
                    <img id="product-img" class="img-fluid rounded mb-4" alt="Product image" onerror="this.parentElement.style.display='none';document.getElementById('no-image').style.display='block';">
                </div>
                <div id="no-image" style="display: none;" class="bg-light p-5 text-center mb-4">
                    <i class="bi bi-image" style="font-size: 2rem;"></i>
                    <p>No image available</p>
                </div>

                <h2 id="product-name">No title provided</h2>
                <h4 id="product-price" class="text-primary">Price not set</h4>
                <p id="product-description" class="text-muted">No description provided</p>

                <div class="d-flex justify-content-between mb-4">
                    <span id="product-stock" class="badge bg-success"></span>
                    <small class="text-muted">Product ID: <span id="product-id">N/A</span></small>
                </div>

                <h4>Description</h4>
                <p id="product-description-full" class="mb-4">No description provided</p>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start mb-5">
                    <a href="/productList.html" class="btn btn-outline-secondary me-md-2">Back to Products</a>
                    <div class="input-group w-auto">
                        <input type="number" id="cart-quantity" class="form-control" min="1" value="1" style="max-width: 80px;">
                        <button id="add-to-cart" class="btn btn-success">Add to Cart</button>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title">Contact Seller</h5>
                    </div>
                    <div class="card-body" id="seller-info">
                        <p class="card-text">Interested in this product?</p>
                        <p>Posted by: <span id="seller-name">Seller Name</span></p>
                        <p>Email: <span id="seller-email">Seller Email</span></p>
                        <a id="seller-email-link" href="#" class="btn btn-primary">Email Seller</a>
                        <p id="no-seller-info" class="text-muted" style="display: none;">Contact info not available</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Not Found -->
    <div id="not-found" class="alert alert-danger" style="display: none;">
        <h4>Product Not Found</h4>
        <p>The requested product could not be found.</p>
        <a href="/productList.html" class="btn btn-primary">View All Products</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Logout functionality
    document.getElementById('logout-link').addEventListener('click', (e) => {
        e.preventDefault();
        window.location.href = '/logout';
    });

    // Fetch product details with retry
    function fetchProductDetails(attempt = 1, maxAttempts = 3) {
        console.log(`Fetching product details (Attempt ${attempt}/${maxAttempts})...`);
        const errorMessage = document.getElementById('error-message');
        const productDetails = document.getElementById('product-details');
        const notFound = document.getElementById('not-found');
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            errorMessage.textContent = 'No product ID provided in URL.';
            errorMessage.style.display = 'block';
            setTimeout(() => errorMessage.style.display = 'none', 5000);
            return;
        }

        errorMessage.style.display = 'none';
        productDetails.style.display = 'none';
        notFound.style.display = 'none';

        fetch(`/api/products/public/${productId}?t=${Date.now()}`, {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                console.log('GET Response:', {
                    status: response.status,
                    statusText: response.statusText,
                    url: response.url
                });
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Failed to fetch product: ${response.status} ${response.statusText} - ${text || 'No response body'}`);
                    });
                }
                return response.json();
            })
            .then(product => {
                console.log('Product received:', product);
                // Populate product details
                document.getElementById('product-name').textContent = product.productName || 'No title provided';
                document.getElementById('product-price').textContent = product.productPrice ? `${product.productPrice.toFixed(2)} LKR` : 'Price not set';
                document.getElementById('product-description').textContent = product.description || 'No description provided';
                document.getElementById('product-description-full').textContent = product.description || 'No description provided';
                document.getElementById('product-id').textContent = product.productID || product.id || 'N/A';
                document.getElementById('product-stock').textContent = `Stock: ${product.productCount || 0}`;
                document.getElementById('product-stock').className = product.productCount > 0 ? 'badge bg-success' : 'badge bg-danger';

                // Handle image
                if (product.images) {
                    document.getElementById('product-img').src = `${product.images}`;
                    document.getElementById('product-image').style.display = 'block';
                    document.getElementById('no-image').style.display = 'none';
                } else {
                    document.getElementById('product-image').style.display = 'none';
                    document.getElementById('no-image').style.display = 'block';
                }

                // Fetch seller info
                fetch(`/api/users/${product.sellerId}`, {
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Failed to fetch seller info');
                        }
                        return response.json();
                    })
                    .then(seller => {
                        console.log('Seller received:', seller);
                        document.getElementById('seller-name').textContent = seller.name || 'Unknown Seller';
                        document.getElementById('seller-email').textContent = seller.email || 'No email provided';
                        document.getElementById('seller-email-link').href = seller.email ? `mailto:${seller.email}` : '#';
                        document.getElementById('seller-info').style.display = 'block';
                        document.getElementById('no-seller-info').style.display = seller.email ? 'none' : 'block';
                    })
                    .catch(error => {
                        console.error('Seller fetch error:', error);
                        document.getElementById('seller-name').textContent = 'Unknown Seller';
                        document.getElementById('seller-email').textContent = 'No email provided';
                        document.getElementById('seller-email-link').href = '#';
                        document.getElementById('seller-info').style.display = 'block';
                        document.getElementById('no-seller-info').style.display = 'block';
                    });

                // Add to Cart button logic
                document.getElementById('add-to-cart').addEventListener('click', () => {
                    const quantity = parseInt(document.getElementById('cart-quantity').value, 10);
                    if (isNaN(quantity) || quantity < 1) {
                        errorMessage.textContent = 'Please enter a valid quantity.';
                        errorMessage.style.display = 'block';
                        setTimeout(() => errorMessage.style.display = 'none', 3000);
                        return;
                    }
                    if (product.productCount < quantity) {
                        errorMessage.textContent = `Only ${product.productCount} items in stock.`;
                        errorMessage.style.display = 'block';
                        setTimeout(() => errorMessage.style.display = 'none', 3000);
                        return;
                    }

                    fetch('/api/cart/add', {
                        method: 'POST',
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            productId: product.id,
                            quantity: quantity
                        })
                    })
                        .then(response => {
                            if (!response.ok) {
                                return response.text().then(text => {
                                    throw new Error(`Failed to add to cart: ${response.status} ${response.statusText} - ${text || 'No response body'}`);
                                });
                            }
                            return response.json();
                        })
                        .then(() => {
                            errorMessage.className = 'alert alert-success';
                            errorMessage.textContent = 'Product added to cart!';
                            errorMessage.style.display = 'block';
                            setTimeout(() => {
                                errorMessage.style.display = 'none';
                                errorMessage.className = 'alert alert-danger';
                            }, 3000);
                        })
                        .catch(error => {
                            console.error('Add to cart error:', error);
                            errorMessage.textContent = error.message.includes('401') ? 'Please log in to add items to cart.' : error.message;
                            errorMessage.style.display = 'block';
                            setTimeout(() => {
                                errorMessage.style.display = 'none';
                                if (error.message.includes('401')) {
                                    window.location.href = '/login.html';
                                }
                            }, 3000);
                        });
                });

                productDetails.style.display = 'block';
            })
            .catch(error => {
                console.error('Fetch error:', error);
                if (attempt < maxAttempts && (error.message.includes('404') || error.message.includes('Failed to fetch'))) {
                    console.log(`Retrying... (Attempt ${attempt + 1}/${maxAttempts})`);
                    setTimeout(() => fetchProductDetails(attempt + 1, maxAttempts), 2000);
                    return;
                }
                let errorText = error.message;
                if (error.message.includes('404')) {
                    notFound.style.display = 'block';
                } else if (error.message.includes('Failed to fetch')) {
                    errorText = 'Unable to connect to the server. Please check your internet connection or try again later.';
                }
                if (!notFound.style.display) {
                    errorMessage.textContent = errorText;
                    errorMessage.style.display = 'block';
                    setTimeout(() => errorMessage.style.display = 'none', 5000);
                }
            });
    }

    // Fetch product details on page load
    window.addEventListener('load', () => fetchProductDetails());
</script>
</body>
</html>